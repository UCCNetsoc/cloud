<template>
  <v-container>
    <card-dialog
      :visible="visible"
      width="380"
    >
      <v-card-title class="justify-center text-center white--text font-weight-light">
        new password
      </v-card-title>
      <v-divider/>
      <v-card-text>
        <v-form
          lazy-validation
          ref="form"
        >
          <v-text-field
            label='Email or username'
            v-model='emailOrUsername'
            :rules='required'
            :disabled='$route.params.emailOrUsername !== undefined'
          ></v-text-field>
          <v-text-field
            label='Reset token'
            v-model='token'
            :rules='required'
            :disabled='$route.params.token !== undefined'
          ></v-text-field>
          <v-text-field
            label='New password'
            v-model='password'
            :rules='passwordRules'
            type='password'
          ></v-text-field>
          <v-text-field
            label='Confirm password'
            v-model='confirmPassword'
            :rules='confirmPasswordRules'
            type='password'
          ></v-text-field>
        </v-form>
      </v-card-text>
      <v-divider/>
      <v-card-actions class="justify-center ma-3">
        <v-btn v-on:click="submit()" color="green">Confirm</v-btn>
        <v-btn v-on:click="$emit('cancelled')" color="red">Cancel</v-btn>
      </v-card-actions>
    </card-dialog>
    <card-dialog
      :visible="resultDialog.visible"
      width="480"
    >
      <v-card-text class="justify-center text-center">
        {{ this.resultDialog.msg }}
      </v-card-text>
      <v-card-actions class="justify-center mb-4">
        <v-btn v-on:click="closeResultDialog()" color="green">Okay</v-btn>
      </v-card-actions>
    </card-dialog>
  </v-container>
</template>

<script lang='ts'>
import Vue from 'vue'
import CardDialog from '@/components/CardDialog.vue'
import { config } from '@/config'
import { fetchRest } from '@/api/rest'
import { openApiPropertyValidator, openApiGetSchemaProperty } from '@/api/openapi'

export default Vue.extend({
  name: 'ResetPasswordForm',
  components: {
    CardDialog
  },
  computed: {
    required () {
      return [
        (v: string) => !!v || 'Required'
      ]
    },

    passwordRules () {
      return [
        (v: string) => !!v || 'Password required',
        openApiPropertyValidator(openApiGetSchemaProperty('UCCStudent', 'password'))
      ]
    },

    confirmPasswordRules () {
      return [
        () => (this.password === this.confirmPassword) || 'Passwords do not match'
      ]
    }
  },

  methods: {
    closeResultDialog () {
      this.resultDialog.visible = false

      if (this.successful) {
        this.$emit('successful')
      }
    },

    async submit () {
      if (this.$refs.form.validate()) {
        try {
          const res = await fetchRest(`${config.apiBaseUrl}/v1/accounts/${this.emailOrUsername}/password`, {
            method: 'POST',
            body: JSON.stringify({
              password: this.password,
              reset: {
                token: this.token
              }
            })
          })

          const { detail } = await res.json()
          this.resultDialog = {
            visible: true,
            msg: detail.msg
          }
          this.successful = (res.status === 201)
        } catch (e) {
          this.resultDialog = {
            visible: true,
            msg: `Could not set your password. ${e.message}`
          }
        }
      }
    }
  },

  mounted () {
    this.token = this.$route.params.token || ''
    this.emailOrUsername = this.$route.params.emailOrUsername || ''
  },

  data: () => ({
    visible: true,
    token: '',
    emailOrUsername: '',

    password: '',
    confirmPassword: '',
    successful: false,

    resultDialog: {
      visible: false,
      msg: ''
    }

  })

})
</script>
